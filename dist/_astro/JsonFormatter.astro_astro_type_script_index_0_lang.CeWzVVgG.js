let S="format",a="",c="";const y=document.getElementById("input-json"),u=document.getElementById("output-json"),k=document.getElementById("error-message"),w=document.getElementById("success-message"),B=document.getElementById("error-text"),I=document.getElementById("success-text"),L=document.getElementById("input-status"),x=document.getElementById("output-status"),E=document.getElementById("convert-options");document.addEventListener("DOMContentLoaded",function(){b(),J(),T()});function b(){document.querySelectorAll(".tab-button").forEach(t=>{t.addEventListener("click",function(){const s=this.getAttribute("data-tab");O(s)})})}function O(e){S=e,document.querySelectorAll(".tab-button").forEach(t=>{t.classList.remove("active")}),document.getElementById(`${e}-tab`)?.classList.add("active"),e==="convert"?E.classList.remove("hidden"):E.classList.add("hidden"),y.value&&v()}function J(){document.getElementById("clear-btn")?.addEventListener("click",M),document.getElementById("copy-btn")?.addEventListener("click",X),document.getElementById("import-btn")?.addEventListener("click",()=>{document.getElementById("file-input")?.click()}),document.getElementById("file-input")?.addEventListener("change",_),document.getElementById("export-btn")?.addEventListener("click",D),document.querySelectorAll(".convert-btn").forEach(e=>{e.addEventListener("click",function(){const t=this.getAttribute("data-format");U(t)})})}function T(){y.addEventListener("input",function(){a=this.value,$(),v()})}function v(){if(f(),!a.trim()){u.value="",i();return}try{switch(S){case"format":A();break;case"compress":C();break;case"unescape":q();break;case"validate":R();break;case"convert":break}}catch(e){p(e.message)}}function A(){const e=g(a);c=JSON.stringify(e,null,2),u.value=c,i(),l("JSON 已格式化")}function C(){const e=g(a);c=JSON.stringify(e),u.value=c,i(),l("JSON 已压缩")}function q(){try{c=JSON.parse(`"${a}"`),u.value=c,i(),l("JSON 已去转义")}catch{c=a,u.value=c,i(),l("内容已处理")}}function R(){try{g(a),c="✅ JSON 格式正确",u.value=c,i(),l("JSON 验证通过")}catch(e){c=`❌ JSON 格式错误: ${e.message}`,u.value=c,i(),p(`JSON 验证失败: ${e.message}`)}}function g(e){const t=document.getElementById("allow-unquoted-keys").checked,s=document.getElementById("allow-single-quotes").checked,o=document.getElementById("allow-trailing-commas").checked;let n=e.trim();return s&&(n=n.replace(/'/g,'"')),t&&(n=n.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g,'$1"$2":')),o&&(n=n.replace(/,(\s*[}\]])/g,"$1")),JSON.parse(n)}function U(e){try{const t=g(a);switch(e){case"yaml":c=h(t);break;case"xml":c=z(t);break;case"csv":c=F(t);break;default:throw new Error(`不支持的格式: ${e}`)}u.value=c,i(),l(`已转换为 ${e.toUpperCase()} 格式`)}catch(t){p(`转换失败: ${t.message}`)}}function h(e,t=0){const s="  ".repeat(t);if(e===null)return"null";if(typeof e=="string")return`"${e}"`;if(typeof e=="number"||typeof e=="boolean")return String(e);if(Array.isArray(e))return e.length===0?"[]":e.map(o=>`${s}- ${h(o,t+1)}`).join(`
`);if(typeof e=="object"){const o=Object.keys(e);return o.length===0?"{}":o.map(n=>`${s}${n}: ${h(e[n],t+1)}`).join(`
`)}return String(e)}function z(e,t="root"){function s(n,r){if(n===null)return`<${r}></${r}>`;if(typeof n=="string")return`<${r}>${o(n)}</${r}>`;if(typeof n=="number"||typeof n=="boolean")return`<${r}>${n}</${r}>`;if(Array.isArray(n))return n.map((d,m)=>s(d,`${r}_${m}`)).join("");if(typeof n=="object"){const d=Object.keys(n).map(m=>s(n[m],m)).join("");return`<${r}>${d}</${r}>`}return`<${r}>${n}</${r}>`}function o(n){return n.replace(/[<>&'"]/g,function(r){switch(r){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case'"':return"&quot;";case"'":return"&#39;";default:return r}})}return`<?xml version="1.0" encoding="UTF-8"?>
${s(e,t)}`}function F(e){if(!Array.isArray(e))throw new Error("CSV 转换只支持数组格式的 JSON");if(e.length===0)return"";const t=new Set;e.forEach(r=>{typeof r=="object"&&r!==null&&Object.keys(r).forEach(d=>t.add(d))});const s=Array.from(t),o=s.map(r=>`"${r}"`).join(","),n=e.map(r=>s.map(d=>{const m=r&&typeof r=="object"?r[d]:"";return`"${String(m||"").replace(/"/g,'""')}"`}).join(","));return[o,...n].join(`
`)}function M(){y.value="",u.value="",a="",c="",$(),i(),f()}async function X(){if(!c){p("没有可复制的内容");return}try{await navigator.clipboard.writeText(c),l("已复制到剪贴板")}catch{const t=document.createElement("textarea");t.value=c,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),l("已复制到剪贴板")}}function _(e){const t=e.target.files?.[0];if(!t)return;const s=new FileReader;s.onload=function(o){const n=o.target?.result;y.value=n,a=n,$(),v()},s.readAsText(t)}function D(){if(!c){p("没有可导出的内容");return}const e=new Blob([c],{type:"text/plain"}),t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download=`json-result-${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.txt`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(t),l("文件已导出")}function $(){const e=a.length,t=a.split(`
`).length;L.textContent=`${e} 字符, ${t} 行`}function i(){const e=c.length,t=c.split(`
`).length;x.textContent=`${e} 字符, ${t} 行`}function p(e){f(),B.textContent=e,k.classList.remove("hidden"),setTimeout(f,5e3)}function l(e){f(),I.textContent=e,w.classList.remove("hidden"),setTimeout(f,3e3)}function f(){k.classList.add("hidden"),w.classList.add("hidden")}
