---
import { t } from '../i18n/translations';
import type { Language } from '../i18n/index';
import { XCircle, CheckCircle } from '@lucide/astro';

interface Props {
  lang?: Language;
}

const { lang = 'en' } = Astro.props;
const translate = t(lang);

// 预先获取所有翻译字符串
const translations = {
  message: {
    cleared: translate('message.cleared'),
    copied: translate('message.copied'),
    pasted: translate('message.pasted'),
    imported: translate('message.imported'),
    exported: translate('message.exported'),
    formatted: translate('message.formatted'),
    compressed: translate('message.compressed'),
    unescaped: translate('message.unescaped'),
    valid: translate('message.valid'),
    invalid: translate('message.invalid'),
    converted: translate('message.converted'),
    processed: translate('message.processed'),
    nothingCopy: translate('message.nothing.copy'),
    nothingExport: translate('message.nothing.export'),
    clipboardEmpty: translate('message.clipboard.empty'),
    clipboardPermission: translate('message.clipboard.permission'),
    manualPaste: translate('message.manual.paste'),
    fileLoaded: translate('message.file.loaded'),
    invalidFile: translate('message.invalid.file'),
    historyLoaded: translate('message.history.loaded'),
    validationFailed: translate('message.invalid'),
  },
  validate: {
    resultValid: translate('validate.result.valid'),
    resultError: translate('validate.result.error'),
  },
  convert: {
    errorCsv: translate('convert.error.csv'),
    errorUnsupported: translate('convert.error.unsupported'),
    errorFailed: translate('convert.error.failed'),
  },
  status: {
    format: translate('status.format'),
  },
  ui: {
    treeExpandAll: translate('ui.tree.expandAll'),
    treeCollapseAll: translate('ui.tree.collapseAll'),
  }
};
---

<div class="formatter-wrapper">
  <div class="formatter-container">
  <!-- 头部 -->
  <header class="formatter-header">
    <h1 class="page-title">JSON Formatter</h1>
    <p class="page-subtitle">Professional JSON processing tool</p>
  </header>

  <!-- 功能选项卡 -->
  <div class="tabs-wrapper">
    <nav class="tabs">
      <button id="format-tab" class="tab active" data-tab="format">
        {translate('formatter.button.format')}
      </button>
      <button id="compress-tab" class="tab" data-tab="compress">
        {translate('formatter.button.compress')}
      </button>
      <button id="unescape-tab" class="tab" data-tab="unescape">
        {translate('ui.unescape')}
      </button>
      <button id="validate-tab" class="tab" data-tab="validate">
        {translate('formatter.button.validate')}
      </button>
      <button id="convert-tab" class="tab" data-tab="convert">
        {translate('ui.convert')}
      </button>
    </nav>
  </div>

  <!-- 配置选项 -->
  <div class="options-section">
    <div class="options-grid">
      <label class="checkbox-label">
        <input type="checkbox" id="allow-unquoted-keys" checked />
        <span>{translate('ui.option.unquoted')}</span>
      </label>

      <label class="checkbox-label">
        <input type="checkbox" id="allow-single-quotes" checked />
        <span>{translate('ui.option.single.quotes')}</span>
      </label>

      <label class="checkbox-label">
        <input type="checkbox" id="allow-trailing-commas" checked />
        <span>{translate('ui.option.trailing.commas')}</span>
      </label>

      <label class="checkbox-label">
        <input type="checkbox" id="remove-surrounding-quotes" checked />
        <span>{translate('ui.option.remove.quotes')}</span>
      </label>

      <label class="checkbox-label">
        <input type="checkbox" id="auto-unescape" checked />
        <span>{translate('ui.option.auto.unescape')}</span>
      </label>

      <label class="checkbox-label">
        <input type="checkbox" id="allow-trailing-semicolon" checked />
        <span>{translate('ui.option.trailing.semicolon')}</span>
      </label>

      <label class="checkbox-label">
        <input type="checkbox" id="remove-comments" checked />
        <span>{translate('ui.option.remove.comments')}</span>
      </label>
    </div>
  </div>

  <!-- 主编辑器 -->
  <div class="editor-layout">
    <!-- 输入 -->
    <div class="editor-side input-side">
      <div class="editor-header">
        <span class="editor-label">Input</span>
        <span id="input-status" class="status-text"></span>
      </div>
      <div class="editor-content" id="drop-zone">
        <textarea
          id="input-json"
          class="code-editor"
          placeholder={translate('formatter.input.placeholder')}></textarea>
        <div class="drop-overlay" id="drop-overlay">
          <p class="drop-text">{translate('drag.drop.text')}</p>
        </div>
      </div>
    </div>

    <!-- 输出 -->
    <div class="editor-side output-side">
      <div class="editor-header">
        <span class="editor-label">Output</span>
        <div class="header-actions">
          <span id="output-status" class="status-text"></span>
          <div class="view-switcher">
            <button id="text-view-btn" class="view-btn active" data-view="text">Text</button>
            <button id="tree-view-btn" class="view-btn" data-view="tree">Tree</button>
          </div>
        </div>
      </div>

      <textarea
        id="output-json"
        class="code-editor"
        readonly
        placeholder={translate('formatter.output.placeholder')}></textarea>

      <div id="tree-view-container" class="tree-container hidden">
        <div class="tree-toolbar">
          <input type="text" id="tree-search" placeholder={translate('ui.tree.search')} class="search-input" />
          <div class="tree-buttons">
            <button id="tree-expand-all" class="tree-btn">{translate('ui.tree.expandAll')}</button>
            <button id="tree-collapse-all" class="tree-btn">{translate('ui.tree.collapseAll')}</button>
          </div>
        </div>
        <div id="tree-view" class="tree-content"></div>
      </div>
    </div>
  </div>

  <!-- 工具栏 -->
  <div class="action-toolbar">
    <button id="clear-btn" class="action-btn" title="Ctrl+Shift+C">
      {translate('formatter.button.clear')}
    </button>
    <button id="paste-btn" class="action-btn" title="Ctrl+Shift+V">
      {translate('formatter.button.paste')}
    </button>
    <button id="copy-btn" class="action-btn" title="Ctrl+Shift+C">
      {translate('formatter.button.copy')}
    </button>
    <input type="file" id="file-input" accept=".json,.txt" class="hidden" />
    <button id="import-btn" class="action-btn" title="Ctrl+O">
      {translate('ui.import')}
    </button>
    <button id="export-btn" class="action-btn" title="Ctrl+S">
      {translate('formatter.button.download')}
    </button>
    <button id="history-btn" class="action-btn" title="Ctrl+H">
      {translate('history.button')}
    </button>
  </div>

  <!-- 转换面板 -->
  <div id="convert-options" class="convert-section hidden">
    <div class="convert-grid">
      <button id="to-yaml-btn" class="convert-card" data-format="yaml">
        <span class="convert-format">YAML</span>
      </button>
      <button id="to-xml-btn" class="convert-card" data-format="xml">
        <span class="convert-format">XML</span>
      </button>
      <button id="to-csv-btn" class="convert-card" data-format="csv">
        <span class="convert-format">CSV</span>
      </button>
    </div>
  </div>

  <!-- 历史记录面板 -->
  <div id="history-panel" class="history-panel hidden">
    <div class="history-header">
      <h3>{translate('history.title')}</h3>
      <button id="close-history" class="close-btn">×</button>
    </div>
    <div class="history-list" id="history-list"></div>
  </div>

  <!-- 消息提示 -->
  <div id="error-message" class="message-toast error hidden">
    <XCircle class="toast-icon" />
    <p id="error-text" class="toast-text"></p>
  </div>

  <div id="success-message" class="message-toast success hidden">
    <CheckCircle class="toast-icon" />
    <p id="success-text" class="toast-text"></p>
  </div>
  <script type="application/json" id="formatter-translations" set:html={JSON.stringify(translations)} />
  </div>
</div>

<style>
  /* ===== 基础 CSS 变量 ===== */
  :root {
    --transition: 150ms ease;
  }

  /* ==================== 风格 1: 优雅极简 ==================== */
  [data-style="minimal"] {
    --font-sans: 'Inter', -apple-system, sans-serif;
    --font-mono: 'JetBrains Mono', 'SF Mono', monospace;

    --bg-primary: #ffffff;
    --bg-secondary: #fafafa;
    --bg-tertiary: #f5f5f5;
    --bg-hover: #f0f0f0;

    --text-primary: #111111;
    --text-secondary: #666666;
    --text-tertiary: #999999;
    --text-inverse: #ffffff;

    --border-light: #e5e5e5;
    --border-medium: #d4d4d4;

    --accent: #0066cc;
    --accent-hover: #0052a3;
    --accent-light: #e6f0ff;

    --success: #00a86b;
    --success-bg: #e8f7f2;
    --error: #dc2626;
    --error-bg: #fef2f2;

    --radius-sm: 4px;
    --radius-md: 6px;
    --radius-lg: 8px;

    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.08);
  }

  /* ==================== 风格 2: 温暖编辑 ==================== */
  [data-style="editorial"] {
    --font-sans: 'Source Sans Pro', sans-serif;
    --font-serif: 'Cormorant Garamond', Georgia, serif;
    --font-mono: 'Fira Code', 'Courier New', monospace;

    --bg-primary: #fdfbf7;
    --bg-secondary: #f8f5f0;
    --bg-tertiary: #f3efe8;
    --bg-hover: #ede8e0;

    --text-primary: #2c2416;
    --text-secondary: #6b5d4f;
    --text-tertiary: #9a8b7a;
    --text-inverse: #ffffff;

    --border-light: #e8ddd0;
    --border-medium: #d4c4b0;

    --accent: #c17f59;
    --accent-hover: #a86745;
    --accent-light: #f5ebe3;

    --success: #7da87b;
    --success-bg: #e8f3e8;
    --error: #c45c5c;
    --error-bg: #f5e8e8;

    --radius-sm: 2px;
    --radius-md: 3px;
    --radius-lg: 4px;

    --shadow-sm: 0 1px 3px rgba(44, 36, 22, 0.06);
    --shadow-md: 0 4px 12px rgba(44, 36, 22, 0.08);
    --shadow-lg: 0 8px 24px rgba(44, 36, 22, 0.10);
  }

  /* ==================== 风格 3: 新粗野主义波普 ==================== */
  [data-style="brutalist"] {
    --font-display: 'Archivo Black', sans-serif;
    --font-sans: 'Space Grotesk', sans-serif;
    --font-mono: 'Space Mono', monospace;

    --bg-primary: #0a0a0a;
    --bg-secondary: #1a1a1a;
    --bg-tertiary: #2a2a2a;
    --bg-hover: #333333;

    --text-primary: #ffffff;
    --text-secondary: #cccccc;
    --text-tertiary: #888888;
    --text-inverse: #000000;

    --border-light: #ff00ff;
    --border-medium: #00ffff;

    --accent: #ff00ff;
    --accent-hover: #ff66ff;
    --accent-light: #ff00ff33;

    --success: #00ff00;
    --success-bg: #00ff0022;
    --error: #ffff00;
    --error-bg: #ffff0022;

    --radius-sm: 0;
    --radius-md: 0;
    --radius-lg: 0;

    --shadow-sm: 4px 4px 0 #ff00ff;
    --shadow-md: 6px 6px 0 #00ffff;
    --shadow-lg: 8px 8px 0 #ffff00;
  }

  /* ==================== 风格 4: 未来玻璃 ==================== */
  [data-style="glass"] {
    --font-sans: 'Outfit', sans-serif;
    --font-mono: 'Rajdhani', monospace;

    --bg-primary: #0f0f23;
    --bg-secondary: #1a1a3e;
    --bg-tertiary: #252559;
    --bg-hover: #303070;

    --text-primary: #ffffff;
    --text-secondary: #b8b8d1;
    --text-tertiary: #7878a0;
    --text-inverse: #0f0f23;

    --border-light: rgba(255, 255, 255, 0.1);
    --border-medium: rgba(255, 255, 255, 0.2);

    --accent: #a78bfa;
    --accent-hover: #c4b5fd;
    --accent-light: rgba(167, 139, 250, 0.2);

    --success: #4ade80;
    --success-bg: rgba(74, 222, 128, 0.15);
    --error: #f87171;
    --error-bg: rgba(248, 113, 113, 0.15);

    --radius-sm: 12px;
    --radius-md: 16px;
    --radius-lg: 24px;

    --shadow-sm: 0 4px 16px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.15);
    --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }

  /* ==================== 风格 5: 复古终端 ==================== */
  [data-style="terminal"] {
    --font-mono: 'VT323', 'Courier New', monospace;

    --bg-primary: #0c0c0c;
    --bg-secondary: #111111;
    --bg-tertiary: #1a1a1a;
    --bg-hover: #222222;

    --text-primary: #00ff00;
    --text-secondary: #00cc00;
    --text-tertiary: #009900;
    --text-inverse: #000000;

    --border-light: #003300;
    --border-medium: #006600;

    --accent: #00ff00;
    --accent-hover: #00cc00;
    --accent-light: #001a00;

    --success: #00ff00;
    --success-bg: #001a00;
    --error: #00ff00;
    --error-bg: #001a00;

    --radius-sm: 0;
    --radius-md: 0;
    --radius-lg: 0;

    --shadow-sm: none;
    --shadow-md: none;
    --shadow-lg: none;
  }

  /* ===== 深色模式叠加 ===== */
  .dark[data-style="minimal"],
  .dark[data-style="editorial"] {
    --bg-primary: #0a0a0a;
    --bg-secondary: #111111;
    --bg-tertiary: #1a1a1a;
    --bg-hover: #222222;

    --text-primary: #f5f5f5;
    --text-secondary: #a0a0a0;
    --text-tertiary: #666666;
    --text-inverse: #000000;

    --border-light: #2a2a2a;
    --border-medium: #333333;
  }

  /* ===== 基础样式 ===== */
  .formatter-wrapper {
    font-family: var(--font-sans, sans-serif);
    background: var(--bg-primary);
    color: var(--text-primary);
    position: relative;
    min-height: 100vh;
    transition: background 0.3s ease, color 0.3s ease;
    width: 100%;
  }

  .formatter-container {
    padding: 3rem 2rem;
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
  }

  /* ===== 风格切换器 ===== */
  .style-switcher {
    position: fixed;
    top: 2rem;
    right: 2rem;
    z-index: 1000;
  }

  .switcher-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border-medium);
    border-radius: var(--radius-lg);
    font-family: var(--font-sans);
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition);
    box-shadow: var(--shadow-md);
  }

  .switcher-toggle:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .toggle-icon {
    width: 18px;
    height: 18px;
  }

  .style-panel {
    position: absolute;
    top: calc(100% + 0.75rem);
    right: 0;
    width: 280px;
    background: var(--bg-primary);
    border: 2px solid var(--border-medium);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    box-shadow: var(--shadow-lg);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all var(--transition);
  }

  .style-panel.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .style-panel-header {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-light);
  }

  .style-options {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .style-option {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border-light);
    border-radius: var(--radius-md);
    font-family: var(--font-sans);
    font-size: 0.875rem;
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition);
  }

  .style-option:hover {
    border-color: var(--accent);
    background: var(--bg-hover);
  }

  .style-option.active {
    border-color: var(--accent);
    background: var(--accent-light);
    color: var(--accent);
  }

  .style-preview {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    flex-shrink: 0;
    border: 2px solid var(--border-medium);
  }

  .style-preview.minimal {
    background: linear-gradient(135deg, #ffffff 50%, #0066cc 50%);
  }

  .style-preview.editorial {
    background: linear-gradient(135deg, #fdfbf7 50%, #c17f59 50%);
  }

  .style-preview.brutalist {
    background: linear-gradient(135deg, #0a0a0a 50%, #ff00ff 50%);
  }

  .style-preview.glass {
    background: linear-gradient(135deg, #0f0f23 50%, #a78bfa 50%);
  }

  .style-preview.terminal {
    background: linear-gradient(135deg, #0c0c0c 50%, #00ff00 50%);
  }

  /* ===== 头部 ===== */
  .formatter-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .page-title {
    font-size: 2.5rem;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0 0 0.75rem 0;
    color: var(--text-primary);
    transition: color 0.3s ease;
  }

  [data-style="editorial"] .page-title {
    font-family: var(--font-serif);
    font-weight: 700;
  }

  [data-style="brutalist"] .page-title {
    font-family: var(--font-display);
    text-transform: uppercase;
    font-size: 3rem;
  }

  [data-style="terminal"] .page-title {
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.2em;
  }

  .page-subtitle {
    font-size: 0.9375rem;
    font-weight: 400;
    color: var(--text-secondary);
    margin: 0;
    transition: color 0.3s ease;
  }

  /* ===== 选项卡 ===== */
  .tabs-wrapper {
    margin-bottom: 2rem;
  }

  .tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border-light);
  }

  [data-style="brutalist"] .tabs {
    border: 2px solid var(--border-medium);
    border-bottom: none;
  }

  .tab {
    padding: 0.875rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    font-family: var(--font-sans);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition);
    white-space: nowrap;
    margin-bottom: -1px;
  }

  [data-style="brutalist"] .tab {
    border: 2px solid transparent;
    border-bottom: none;
    margin-bottom: 0;
    font-family: var(--font-display);
    text-transform: uppercase;
  }

  [data-style="terminal"] .tab {
    font-family: var(--font-mono);
    font-size: 1rem;
  }

  .tab:hover {
    color: var(--text-primary);
  }

  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  [data-style="brutalist"] .tab.active {
    background: var(--accent);
    color: var(--text-inverse);
    border-color: var(--accent);
  }

  [data-style="glass"] .tab.active {
    background: var(--accent-light);
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
  }

  /* ===== 配置选项 ===== */
  .options-section {
    padding: 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    margin-bottom: 2rem;
    transition: all 0.3s ease;
  }

  [data-style="brutalist"] .options-section {
    border: 3px solid var(--border-medium);
    box-shadow: var(--shadow-sm);
  }

  [data-style="glass"] .options-section {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-medium);
  }

  .options-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem 2rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    cursor: pointer;
    user-select: none;
    font-size: 0.875rem;
    color: var(--text-primary);
    transition: color 0.3s ease;
  }

  .checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    border: 1.5px solid var(--border-medium);
    border-radius: var(--radius-sm);
    cursor: pointer;
    appearance: none;
    position: relative;
    transition: all var(--transition);
  }

  [data-style="brutalist"] .checkbox-label input[type="checkbox"] {
    border-width: 2px;
  }

  .checkbox-label input[type="checkbox"]:checked {
    background: var(--accent);
    border-color: var(--accent);
  }

  .checkbox-label input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 4px;
    width: 4px;
    height: 8px;
    border: solid var(--text-inverse);
    border-width: 0 1.5px 1.5px 0;
    transform: rotate(45deg);
  }

  .checkbox-label input[type="checkbox"]:hover {
    border-color: var(--accent);
  }

  /* ===== 编辑器布局 ===== */
  .editor-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 1024px) {
    .editor-layout {
      grid-template-columns: 1fr;
    }
  }

  .editor-side {
    display: flex;
    flex-direction: column;
  }

  .editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    margin-bottom: 0.75rem;
  }

  .editor-label {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--text-secondary);
    transition: color 0.3s ease;
  }

  [data-style="editorial"] .editor-label {
    font-family: var(--font-serif);
    font-style: italic;
    text-transform: none;
    letter-spacing: 0.02em;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .status-text {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-tertiary);
    transition: color 0.3s ease;
  }

  .view-switcher {
    display: flex;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    padding: 0.125rem;
    border: 1px solid var(--border-light);
  }

  [data-style="brutalist"] .view-switcher {
    border: 2px solid var(--border-medium);
  }

  .view-btn {
    padding: 0.375rem 0.75rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    font-family: var(--font-sans);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition);
  }

  .view-btn:hover {
    color: var(--text-primary);
  }

  .view-btn.active {
    background: var(--bg-primary);
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
  }

  [data-style="brutalist"] .view-btn.active {
    background: var(--accent);
    color: var(--text-inverse);
    box-shadow: none;
  }

  [data-style="terminal"] .view-btn {
    font-family: var(--font-mono);
    font-size: 0.875rem;
  }

  .editor-content {
    position: relative;
    flex: 1;
  }

  .code-editor {
    width: 100%;
    min-height: 480px;
    padding: 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    line-height: 1.6;
    color: var(--text-primary);
    resize: vertical;
    transition: all 0.3s ease;
  }

  .input-side .code-editor {
    min-height: 500px;
  }

  [data-style="brutalist"] .code-editor {
    border: 3px solid var(--border-medium);
  }

  [data-style="glass"] .code-editor {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-medium);
  }

  [data-style="terminal"] .code-editor {
    background: #000;
    border: 2px solid var(--accent);
    font-size: 1.125rem;
  }

  .code-editor:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-light);
  }

  [data-style="brutalist"] .code-editor:focus {
    box-shadow: var(--shadow-sm);
  }

  [data-style="terminal"] .code-editor:focus {
    box-shadow: 0 0 10px var(--accent), inset 0 0 10px rgba(0, 255, 0, 0.1);
  }

  .code-editor::placeholder {
    color: var(--text-tertiary);
  }

  /* ===== 拖拽上传 ===== */
  .drop-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--accent-light);
    border: 3px dashed var(--accent);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition);
    pointer-events: none;
  }

  .drop-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .drop-text {
    font-family: var(--font-sans);
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--accent);
  }

  /* ===== 树状视图 ===== */
  .tree-container {
    flex: 1;
    min-height: 480px;
    display: flex;
    flex-direction: column;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
    transition: all 0.3s ease;
  }

  [data-style="brutalist"] .tree-container {
    border: 3px solid var(--border-medium);
  }

  [data-style="glass"] .tree-container {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-medium);
  }

  [data-style="terminal"] .tree-container {
    background: #000;
    border: 2px solid var(--accent);
  }

  .tree-toolbar {
    display: flex;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-light);
    flex-shrink: 0;
    transition: all 0.3s ease;
  }

  .search-input {
    flex: 1;
    min-width: 200px;
    padding: 0.5rem 0.75rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-family: var(--font-sans);
    font-size: 0.8125rem;
    color: var(--text-primary);
    transition: all 0.3s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--accent);
  }

  [data-style="terminal"] .search-input {
    background: #000;
    border: 1px solid var(--accent);
    color: #0f0;
    font-family: var(--font-mono);
  }

  .tree-buttons {
    display: flex;
    gap: 0.5rem;
  }

  .tree-btn {
    padding: 0.5rem 0.875rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-family: var(--font-sans);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition);
  }

  .tree-btn:hover {
    background: var(--bg-hover);
  }

  [data-style="terminal"] .tree-btn {
    background: #000;
    border: 1px solid var(--accent);
    color: #0f0;
    font-family: var(--font-mono);
  }

  .tree-content {
    flex: 1;
    padding: 1rem;
    overflow: auto;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    line-height: 1.6;
  }

  /* ===== 工具栏 ===== */
  .action-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
    margin-bottom: 2rem;
  }

  .action-btn {
    padding: 0.625rem 1.25rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    font-family: var(--font-sans);
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition);
  }

  [data-style="brutalist"] .action-btn {
    border: 2px solid var(--border-medium);
    box-shadow: var(--shadow-sm);
    font-family: var(--font-display);
    text-transform: uppercase;
  }

  [data-style="editorial"] .action-btn {
    font-family: var(--font-serif);
    font-style: italic;
  }

  [data-style="glass"] .action-btn {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-medium);
  }

  [data-style="terminal"] .action-btn {
    background: #000;
    border: 2px solid var(--accent);
    color: #0f0;
    font-family: var(--font-mono);
    font-size: 0.875rem;
  }

  .action-btn:hover {
    background: var(--bg-hover);
    border-color: var(--accent);
    color: var(--accent);
    transform: translateY(-1px);
  }

  [data-style="brutalist"] .action-btn:hover {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0 var(--accent);
  }

  [data-style="terminal"] .action-btn:hover {
    background: var(--accent);
    color: #000;
    box-shadow: 0 0 10px var(--accent);
  }

  .action-btn:active {
    transform: translateY(0);
  }

  /* ===== 转换面板 ===== */
  .convert-section {
    padding: 2rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    transition: all 0.3s ease;
  }

  [data-style="brutalist"] .convert-section {
    border: 3px solid var(--border-medium);
    box-shadow: var(--shadow-sm);
  }

  [data-style="glass"] .convert-section {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-medium);
  }

  .convert-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  @media (max-width: 640px) {
    .convert-grid {
      grid-template-columns: 1fr;
    }
  }

  .convert-card {
    padding: 1.5rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    font-family: var(--font-sans);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition);
  }

  [data-style="brutalist"] .convert-card {
    border: 2px solid var(--border-medium);
    box-shadow: var(--shadow-sm);
  }

  .convert-card:hover {
    border-color: var(--accent);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  [data-style="brutalist"] .convert-card:hover {
    transform: translate(2px, 2px);
    box-shadow: 4px 4px 0 var(--accent);
  }

  [data-style="glass"] .convert-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
  }

  [data-style="terminal"] .convert-card {
    background: #000;
    border: 2px solid var(--accent);
    color: #0f0;
    font-family: var(--font-mono);
  }

  .convert-format {
    font-size: 1rem;
    font-weight: 600;
  }

  /* ===== 历史记录面板 ===== */
  .history-panel {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: var(--bg-primary);
    border-left: 1px solid var(--border-light);
    box-shadow: var(--shadow-lg);
    transition: right 0.3s ease;
    z-index: 1001;
    display: flex;
    flex-direction: column;
  }

  .history-panel.open {
    right: 0;
  }

  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-light);
  }

  .history-header h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .close-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    font-size: 1.5rem;
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition);
  }

  .close-btn:hover {
    background: var(--bg-hover);
  }

  .history-list {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
  }

  .history-item {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition);
  }

  .history-item:hover {
    border-color: var(--accent);
    background: var(--bg-hover);
  }

  .history-time {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    margin-bottom: 0.25rem;
  }

  .history-preview {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ===== 消息提示 ===== */
  .message-toast {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-radius: var(--radius-md);
    margin-top: 1rem;
    animation: toastIn 0.2s ease;
    transition: all 0.3s ease;
  }

  @keyframes toastIn {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message-toast.error {
    background: var(--error-bg);
    border: 1px solid var(--error);
  }

  [data-style="brutalist"] .message-toast.error {
    background: #ffff0022;
    border: 3px solid #ffff00;
  }

  .message-toast.success {
    background: var(--success-bg);
    border: 1px solid var(--success);
  }

  [data-style="brutalist"] .message-toast.success {
    background: #00ff0022;
    border: 3px solid #00ff00;
  }

  .toast-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .message-toast.error .toast-icon {
    color: var(--error);
  }

  .message-toast.success .toast-icon {
    color: var(--success);
  }

  [data-style="terminal"] .toast-icon {
    color: #0f0 !important;
  }

  .toast-text {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    margin: 0;
  }

  .message-toast.error .toast-text {
    color: var(--error);
  }

  .message-toast.success .toast-text {
    color: var(--success);
  }

  [data-style="terminal"] .toast-text {
    color: #0f0 !important;
  }

  /* ===== 树状视图样式 ===== */
  .tree-node {
    position: relative;
    padding: 0.125rem 0;
    user-select: none;
  }

  .tree-node:hover {
    background: var(--bg-hover);
    border-radius: var(--radius-sm);
  }

  [data-style="brutalist"] .tree-node:hover {
    background: #ff00ff22;
  }

  [data-style="glass"] .tree-node:hover {
    background: rgba(167, 139, 250, 0.1);
  }

  [data-style="terminal"] .tree-node:hover {
    background: #00ff0022;
  }

  .tree-leaf {
    user-select: text;
  }

  .tree-toggle {
    display: inline-block;
    width: 14px;
    text-align: center;
    cursor: pointer;
    color: var(--text-tertiary);
    margin-right: 0.25rem;
    font-size: 10px;
    transition: color var(--transition);
  }

  .tree-toggle:hover {
    color: var(--text-secondary);
  }

  [data-style="terminal"] .tree-toggle:hover {
    color: #0f0;
  }

  .tree-key {
    color: var(--error);
    font-weight: 500;
  }

  [data-style="brutalist"] .tree-key {
    color: #ff00ff;
  }

  [data-style="glass"] .tree-key {
    color: #f87171;
  }

  [data-style="terminal"] .tree-key {
    color: #0f0;
  }

  .tree-bracket {
    color: var(--text-secondary);
  }

  .tree-preview {
    color: var(--text-tertiary);
    font-style: italic;
    margin-left: 0.25rem;
  }

  .tree-value-string {
    color: var(--success);
  }

  [data-style="brutalist"] .tree-value-string {
    color: #00ff00;
  }

  [data-style="glass"] .tree-value-string {
    color: #4ade80;
  }

  [data-style="terminal"] .tree-value-string {
    color: #0f0;
  }

  .tree-value-number {
    color: var(--accent);
  }

  [data-style="brutalist"] .tree-value-number {
    color: #00ffff;
  }

  [data-style="glass"] .tree-value-number {
    color: #a78bfa;
  }

  [data-style="terminal"] .tree-value-number {
    color: #0f0;
  }

  .tree-value-boolean {
    color: #9333ea;
  }

  [data-style="brutalist"] .tree-value-boolean {
    color: #ffff00;
  }

  [data-style="glass"] .tree-value-boolean {
    color: #f472b6;
  }

  .tree-value-null {
    color: var(--text-tertiary);
  }

  .tree-value.editing {
    background: var(--accent-light);
    padding: 0 0.25rem;
    border-radius: var(--radius-sm);
    outline: none;
  }

  .tree-value:not(.editing) {
    cursor: pointer;
  }

  .tree-value:not(.editing):hover {
    background: var(--bg-hover);
    padding: 0 0.25rem;
    border-radius: var(--radius-sm);
  }

  [data-style="terminal"] .tree-value:not(.editing):hover {
    background: #00ff0022;
  }

  :global(.search-highlight) {
    background-color: #fef08a !important;
    padding: 0 0.25rem !important;
    border-radius: var(--radius-sm) !important;
    font-weight: 500 !important;
  }

  :global(.dark .search-highlight) {
    background-color: #713f12 !important;
  }

  [data-style="brutalist"] :global(.search-highlight) {
    background-color: #ffff00 !important;
    color: #000 !important;
  }

  [data-style="terminal"] :global(.search-highlight) {
    background-color: #00ff00 !important;
    color: #000 !important;
  }

  .tree-copy-path {
    margin-left: 0.5rem;
    opacity: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    color: var(--text-tertiary);
    transition: all var(--transition);
  }

  .tree-node:hover .tree-copy-path {
    opacity: 1;
  }

  .tree-copy-path:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
    border-radius: var(--radius-sm);
  }

  .tree-copy-path:active {
    transform: scale(0.95);
  }

  .tree-empty {
    color: var(--text-secondary);
    text-align: center;
    padding: 2rem;
  }

  /* ===== 响应式 ===== */
  @media (max-width: 768px) {
    .formatter-wrapper {
      padding: 1.5rem 1rem;
    }

    .style-switcher {
      top: 1rem;
      right: 1rem;
    }

    .page-title {
      font-size: 1.875rem;
    }

    .tabs {
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .options-grid {
      flex-direction: column;
      gap: 0.875rem;
    }

    .action-toolbar {
      flex-direction: column;
    }

    .action-btn {
      width: 100%;
    }

    .editor-header {
      flex-direction: column;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .view-switcher {
      width: 100%;
    }

    .view-btn {
      flex: 1;
    }

    .tree-toolbar {
      flex-direction: column;
    }

    .tree-buttons {
      width: 100%;
    }

    .tree-btn {
      flex: 1;
    }

    .history-panel {
      width: 100%;
      right: -100%;
    }
  }

  /* ===== 辅助类 ===== */
  .hidden {
    display: none !important;
  }
</style>

<script>
  import TreeViewer from '../scripts/tree-viewer';
  import { parseJsonLeniently, jsonToYaml, jsonToXml, jsonToCsv } from '../scripts/json-parser';
  import type { ParseOptions } from '../scripts/json-parser';

  const translations = JSON.parse(
    document.getElementById('formatter-translations')?.textContent || '{}'
  );

  // 基础变量
  let currentTab = 'format';
  let inputJson = '';
  let outputJson = '';
  let currentView = 'text';
  let currentStyle = 'minimal';
  let treeViewer = null;
  let currentParsedData = null;
  let history = [];

  // DOM 元素
  const inputTextarea = document.getElementById('input-json');
  const outputTextarea = document.getElementById('output-json');
  const errorMessage = document.getElementById('error-message');
  const successMessage = document.getElementById('success-message');
  const errorText = document.getElementById('error-text');
  const successText = document.getElementById('success-text');
  const inputStatus = document.getElementById('input-status');
  const outputStatus = document.getElementById('output-status');
  const convertOptions = document.getElementById('convert-options');
  const treeViewContainer = document.getElementById('tree-view-container');
  const dropZone = document.getElementById('drop-zone');
  const dropOverlay = document.getElementById('drop-overlay');
  const historyPanel = document.getElementById('history-panel');

  // 初始化
  document.addEventListener('DOMContentLoaded', function () {
    initializeTabs();
    initializeButtons();
    initializeTextarea();
    initializeTreeView();
    initializeKeyboardShortcuts();
    initializeDragDrop();
    loadHistory();
  });

  // ===== 键盘快捷键 =====
  function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + Shift + C: 清空
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
        e.preventDefault();
        clearAll();
      }

      // Ctrl/Cmd + Shift + V: 粘贴
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'V') {
        e.preventDefault();
        pasteFromClipboard();
      }

      // Ctrl/Cmd + Shift + X: 复制
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'X') {
        e.preventDefault();
        copyResult();
      }

      // Ctrl/Cmd + O: 导入
      if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
        e.preventDefault();
        document.getElementById('file-input')?.click();
      }

      // Ctrl/Cmd + S: 导出
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        exportResult();
      }

      // Ctrl/Cmd + H: 历史记录
      if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
        e.preventDefault();
        toggleHistory();
      }

      // ESC: 关闭面板
      if (e.key === 'Escape') {
        historyPanel?.classList.remove('open');
      }
    });
  }

  // ===== 拖拽上传 =====
  function initializeDragDrop() {
    if (!dropZone || !dropOverlay) return;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropOverlay?.classList.add('active'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropOverlay?.classList.remove('active'), false);
    });

    dropZone.addEventListener('drop', handleDrop, false);
  }

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt?.files;

    if (files && files.length > 0) {
      const file = files[0];
      if (file.type === 'application/json' || file.name.endsWith('.json') || file.name.endsWith('.txt')) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target?.result;
          inputTextarea.value = content;
          inputJson = content;
          updateInputStatus();
          processInput();
          addToHistory(content);
          showSuccess(translations.message.fileLoaded);
        };
        reader.readAsText(file);
      } else {
        showError(translations.message.invalidFile);
      }
    }
  }

  // ===== 历史记录 =====
  const MAX_HISTORY_ITEMS = 30;
  const MAX_CONTENT_SIZE = 100000;

  function addToHistory(content) {
    if (!content || content.length < 10) return;

    const now = new Date();
    const timeStr = now.toLocaleString();
    const truncated = content.length > MAX_CONTENT_SIZE;

    history.unshift({
      time: timeStr,
      preview: content.substring(0, 100),
      fullContent: truncated ? content.substring(0, MAX_CONTENT_SIZE) : content,
      timestamp: now.getTime()
    });

    if (history.length > MAX_HISTORY_ITEMS) {
      history = history.slice(0, MAX_HISTORY_ITEMS);
    }

    saveHistory();
    renderHistory();
  }

  function saveHistory() {
    try {
      localStorage.setItem('formatter-history', JSON.stringify(history));
    } catch (e) {
      history = history.slice(0, Math.max(1, Math.floor(history.length / 2)));
      try {
        localStorage.setItem('formatter-history', JSON.stringify(history));
      } catch (_) { /* localStorage full, ignore */ }
    }
  }

  function loadHistory() {
    const saved = localStorage.getItem('formatter-history');
    if (saved) {
      try {
        history = JSON.parse(saved);
        renderHistory();
      } catch (e) {
        console.error('Failed to load history:', e);
      }
    }
  }

  function renderHistory() {
    const historyList = document.getElementById('history-list');
    if (!historyList) return;

    historyList.innerHTML = history.map((item, index) => `
      <div class="history-item" data-index="${index}">
        <div class="history-time">${item.time}</div>
        <div class="history-preview">${escapeHtml(item.preview || item.content || '')}</div>
      </div>
    `).join('');

    historyList.querySelectorAll('.history-item').forEach(item => {
      item.addEventListener('click', () => {
        const index = parseInt(item.getAttribute('data-index') || '0');
        const historyItem = history[index];
        if (historyItem && historyItem.fullContent) {
          inputTextarea.value = historyItem.fullContent;
          inputJson = historyItem.fullContent;
          updateInputStatus();
          processInput();
          historyPanel?.classList.remove('open');
          showSuccess(translations.message.historyLoaded);
        }
      });
    });
  }

  function toggleHistory() {
    historyPanel?.classList.toggle('open');
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ===== 初始化选项卡 =====
  function initializeTabs() {
    const tabButtons = document.querySelectorAll('.tab');
    tabButtons.forEach((button) => {
      button.addEventListener('click', function () {
        const tabName = this.getAttribute('data-tab');
        switchTab(tabName);
      });
    });
  }

  // ===== 切换选项卡 =====
  function switchTab(tabName) {
    currentTab = tabName;

    document.querySelectorAll('.tab').forEach((btn) => {
      btn.classList.remove('active');
    });
    document.getElementById(`${tabName}-tab`)?.classList.add('active');

    if (tabName === 'convert') {
      convertOptions.classList.remove('hidden');
    } else {
      convertOptions.classList.add('hidden');
    }

    if (inputTextarea.value) {
      processInput();
    }
  }

  // ===== 初始化按钮 =====
  function initializeButtons() {
    document.getElementById('clear-btn')?.addEventListener('click', clearAll);
    document.getElementById('paste-btn')?.addEventListener('click', pasteFromClipboard);
    document.getElementById('copy-btn')?.addEventListener('click', copyResult);
    document.getElementById('import-btn')?.addEventListener('click', () => {
      document.getElementById('file-input')?.click();
    });
    document.getElementById('file-input')?.addEventListener('change', handleFileImport);
    document.getElementById('export-btn')?.addEventListener('click', exportResult);
    document.getElementById('history-btn')?.addEventListener('click', toggleHistory);
    document.getElementById('close-history')?.addEventListener('click', toggleHistory);

    document.querySelectorAll('.convert-card').forEach((btn) => {
      btn.addEventListener('click', function () {
        const format = this.getAttribute('data-format');
        convertToFormat(format);
      });
    });
  }

  // ===== 初始化文本区域 =====
  function initializeTextarea() {
    let inputDebounceTimer;
    let historyDebounceTimer;
    inputTextarea.addEventListener('input', function () {
      inputJson = this.value;
      updateInputStatus();
      clearTimeout(inputDebounceTimer);
      inputDebounceTimer = setTimeout(() => processInput(), 150);
      clearTimeout(historyDebounceTimer);
      historyDebounceTimer = setTimeout(() => {
        if (inputJson.length > 50) addToHistory(inputJson);
      }, 2000);
    });

    const configCheckboxes = [
      'allow-unquoted-keys',
      'allow-single-quotes',
      'allow-trailing-commas',
      'remove-surrounding-quotes',
      'auto-unescape',
      'allow-trailing-semicolon',
      'remove-comments',
    ];

    configCheckboxes.forEach((id) => {
      const checkbox = document.getElementById(id);
      if (checkbox) {
        checkbox.addEventListener('change', function () {
          if (inputJson.trim()) {
            processInput();
          }
        });
      }
    });
  }

  // ===== 处理输入 =====
  function processInput() {
    hideMessages();

    if (!inputJson.trim()) {
      outputTextarea.value = '';
      updateOutputStatus();
      return;
    }

    try {
      switch (currentTab) {
        case 'format':
          formatJson();
          break;
        case 'compress':
          compressJson();
          break;
        case 'unescape':
          unescapeJson();
          break;
        case 'validate':
          validateJson();
          break;
        case 'convert':
          break;
      }
    } catch (error) {
      showError(error.message);
    }
  }

  // ===== 格式化 JSON =====
  function formatJson() {
    const parsed = parseJsonLeniently(inputJson, getParseOptions());
    currentParsedData = parsed;
    outputJson = JSON.stringify(parsed, null, 2);
    outputTextarea.value = outputJson;
    updateOutputStatus();
    updateTreeView(parsed);
    showSuccess(translations.message.formatted);
  }

  // ===== 压缩 JSON =====
  function compressJson() {
    const parsed = parseJsonLeniently(inputJson, getParseOptions());
    currentParsedData = parsed;
    outputJson = JSON.stringify(parsed);
    outputTextarea.value = outputJson;
    updateOutputStatus();
    updateTreeView(parsed);
    showSuccess(translations.message.compressed);
  }

  // ===== 去转义 JSON =====
  function unescapeJson() {
    let text = inputJson.trim();

    // If wrapped in quotes, try parsing as a JSON string literal first
    if ((text.startsWith('"') && text.endsWith('"')) ||
        (text.startsWith("'") && text.endsWith("'"))) {
      try {
        const parsed = JSON.parse(text.startsWith("'") ? '"' + text.slice(1, -1) + '"' : text);
        outputJson = parsed;
        outputTextarea.value = outputJson;
        updateOutputStatus();
        showSuccess(translations.message.unescaped);
        return;
      } catch (_) { /* fall through */ }
    }

    // Manual unescape for common escape sequences
    try {
      let unescaped = text
        .replace(/\\\\/g, '\x00BACKSLASH\x00')
        .replace(/\\"/g, '"')
        .replace(/\\'/g, "'")
        .replace(/\\n/g, '\n')
        .replace(/\\r/g, '\r')
        .replace(/\\t/g, '\t')
        .replace(/\\b/g, '\b')
        .replace(/\\f/g, '\f')
        .replace(/\\u([0-9a-fA-F]{4})/g, (_, hex) => String.fromCharCode(parseInt(hex, 16)))
        .replace(/\x00BACKSLASH\x00/g, '\\');

      outputJson = unescaped;
      outputTextarea.value = outputJson;
      updateOutputStatus();
      showSuccess(translations.message.unescaped);
    } catch (error) {
      outputJson = text;
      outputTextarea.value = outputJson;
      updateOutputStatus();
      showSuccess(translations.message.processed);
    }
  }

  // ===== 验证 JSON =====
  function validateJson() {
    try {
      const parsed = parseJsonLeniently(inputJson, getParseOptions());
      currentParsedData = parsed;
      outputJson = translations.validate.resultValid;
      outputTextarea.value = outputJson;
      updateOutputStatus();
      updateTreeView(parsed);
      showSuccess(translations.message.valid);
    } catch (error) {
      outputJson = `${translations.validate.resultError}: ${error.message}`;
      outputTextarea.value = outputJson;
      updateOutputStatus();
      currentParsedData = null;
      if (treeViewer) {
        treeViewer.render(null);
      }
      showError(translations.message.validationFailed + `: ${error.message}`);
    }
  }

  // ===== 宽松解析 JSON (delegates to imported module) =====
  function getParseOptions() {
    return {
      allowUnquotedKeys: document.getElementById('allow-unquoted-keys')?.checked ?? false,
      allowSingleQuotes: document.getElementById('allow-single-quotes')?.checked ?? false,
      allowTrailingCommas: document.getElementById('allow-trailing-commas')?.checked ?? false,
      removeSurroundingQuotes: document.getElementById('remove-surrounding-quotes')?.checked ?? false,
      autoUnescape: document.getElementById('auto-unescape')?.checked ?? false,
      allowTrailingSemicolon: document.getElementById('allow-trailing-semicolon')?.checked ?? false,
      removeComments: document.getElementById('remove-comments')?.checked ?? false,
    };
  }

  // ===== 转换为其他格式 =====
  function convertToFormat(format) {
    try {
      const parsed = parseJsonLeniently(inputJson, getParseOptions());
      currentParsedData = parsed;

      switch (format) {
        case 'yaml':
          outputJson = jsonToYaml(parsed);
          break;
        case 'xml':
          outputJson = jsonToXml(parsed);
          break;
        case 'csv':
          outputJson = jsonToCsv(parsed, translations.convert.errorCsv);
          break;
        default:
          throw new Error(translations.convert.errorUnsupported.replace('{format}', format));
      }

      outputTextarea.value = outputJson;
      updateOutputStatus();
      updateTreeView(parsed);
      const formatName = format.toUpperCase();
      showSuccess(translations.message.converted.replace('{format}', formatName));
    } catch (error) {
      showError(translations.convert.errorFailed.replace('{error}', error.message));
    }
  }

  // ===== 清空所有内容 =====
  function clearAll() {
    inputTextarea.value = '';
    outputTextarea.value = '';
    inputJson = '';
    outputJson = '';
    updateInputStatus();
    updateOutputStatus();
    hideMessages();
    showSuccess(translations.message.cleared);
  }

  // ===== 复制结果 =====
  async function copyResult() {
    if (!outputJson) {
      showError(translations.message.nothingCopy);
      return;
    }

    try {
      await navigator.clipboard.writeText(outputJson);
      showSuccess(translations.message.copied);
    } catch (error) {
      showError(translations.message.nothingCopy);
    }
  }

  // ===== 从剪贴板粘贴 =====
  async function pasteFromClipboard() {
    try {
      if (navigator.clipboard && navigator.clipboard.readText) {
        const text = await navigator.clipboard.readText();
        if (text) {
          inputTextarea.value = text;
          inputJson = text;
          updateInputStatus();
          processInput();
          addToHistory(text);
          showSuccess(translations.message.pasted);
        } else {
          showError(translations.message.clipboardEmpty);
        }
      } else {
        inputTextarea.focus();
        showError(translations.message.manualPaste);
      }
    } catch (error) {
      if (error.name === 'NotAllowedError') {
        showError(translations.message.clipboardPermission);
      } else {
        inputTextarea.focus();
        showError(translations.message.manualPaste);
      }
    }
  }

  // ===== 处理文件导入 =====
  function handleFileImport(event) {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      const content = e.target?.result;
      inputTextarea.value = content;
      inputJson = content;
      updateInputStatus();
      processInput();
      addToHistory(content);
      showSuccess(translations.message.imported);
    };
    reader.readAsText(file);
  }

  // ===== 导出结果 =====
  function exportResult() {
    if (!outputJson) {
      showError(translations.message.nothingExport);
      return;
    }

    const blob = new Blob([outputJson], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `json-result-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showSuccess(translations.message.exported);
  }

  // ===== 更新输入状态 =====
  function updateInputStatus() {
    const length = inputJson.length;
    const lines = inputJson.split('\n').length;
    inputStatus.textContent = translations.status.format.replace('{chars}', length).replace('{lines}', lines);
  }

  // ===== 更新输出状态 =====
  function updateOutputStatus() {
    const length = outputJson.length;
    const lines = outputJson.split('\n').length;
    outputStatus.textContent = translations.status.format.replace('{chars}', length).replace('{lines}', lines);
  }

  // ===== 显示错误信息 =====
  function showError(message) {
    hideMessages();
    errorText.textContent = message;
    errorMessage.classList.remove('hidden');
    setTimeout(hideMessages, 5000);
  }

  // ===== 显示成功信息 =====
  function showSuccess(message) {
    hideMessages();
    successText.textContent = message;
    successMessage.classList.remove('hidden');
    setTimeout(hideMessages, 3000);
  }

  // ===== 隐藏所有消息 =====
  function hideMessages() {
    errorMessage.classList.add('hidden');
    successMessage.classList.add('hidden');
  }

  // ===== 初始化树状视图 =====
  function initializeTreeView() {
    treeViewer = new TreeViewer('tree-view', {
      showSuccess,
      showError,
      onDataUpdate: (data) => {
        currentParsedData = data;
        if (currentTab === 'format') {
          outputJson = JSON.stringify(data, null, 2);
        } else if (currentTab === 'compress') {
          outputJson = JSON.stringify(data);
        }
        outputTextarea.value = outputJson;
        updateOutputStatus();
      }
    });

    const textViewBtn = document.getElementById('text-view-btn');
    const treeViewBtn = document.getElementById('tree-view-btn');

    textViewBtn?.addEventListener('click', () => switchView('text'));
    treeViewBtn?.addEventListener('click', () => switchView('tree'));

    const expandAllBtn = document.getElementById('tree-expand-all');
    const collapseAllBtn = document.getElementById('tree-collapse-all');
    const searchInput = document.getElementById('tree-search');

    expandAllBtn?.addEventListener('click', () => {
      if (treeViewer) {
        treeViewer.expandAll();
      }
    });

    collapseAllBtn?.addEventListener('click', () => {
      if (treeViewer) {
        treeViewer.collapseAll();
      }
    });

    let searchTimeout;
    searchInput?.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (treeViewer) {
          treeViewer.search(e.target.value);
        }
      }, 300);
    });

    // onTreeDataUpdate is now handled via TreeViewer callbacks
  }

  // ===== 切换视图 =====
  function switchView(view) {
    currentView = view;

    const textViewBtn = document.getElementById('text-view-btn');
    const treeViewBtn = document.getElementById('tree-view-btn');

    if (view === 'text') {
      outputTextarea.classList.remove('hidden');
      treeViewContainer?.classList.add('hidden');
      textViewBtn?.classList.add('active');
      treeViewBtn?.classList.remove('active');
    } else {
      outputTextarea.classList.add('hidden');
      treeViewContainer?.classList.remove('hidden');
      textViewBtn?.classList.remove('active');
      treeViewBtn?.classList.add('active');

      if (currentParsedData && treeViewer) {
        treeViewer.render(currentParsedData);
      }
    }
  }

  // ===== 更新树视图 =====
  function updateTreeView(data) {
    if (currentView === 'tree' && treeViewer) {
      treeViewer.render(data);
    }
  }

  // ===== 导出全局函数 =====
  window.showSuccess = showSuccess;
  window.showError = showError;
</script>
